<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FPY Monitoring Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#0f172a; color:#e5e7eb; font-family:sans-serif; margin:20px; }
    .card{background:#111827; padding:20px; border-radius:12px; margin-bottom:20px;}
    table{width:100%; border-collapse:collapse; margin-top:10px;}
    th, td{padding:8px; border-bottom:1px solid #333;}
    th{background:#1e293b;}
    .good{color:#22c55e;} .warn{color:#f59e0b;} .bad{color:#ef4444;}
  </style>
</head>
<body>
  <h1>FPY Monitoring Dashboard</h1>

  <!-- KPI -->
  <div class="card">
    <h2>KPIs</h2>
    <p id="kpiFPY">Overall FPY: —</p>
    <p id="kpiModels">Models: —</p>
    <p id="kpiDays">Days Covered: —</p>
  </div>

  <!-- Trend Chart -->
  <div class="card">
    <h2>FPY Trend (per Model)</h2>
    <canvas id="fpyChart" height="120"></canvas>
  </div>

  <!-- Table -->
  <div class="card">
    <h2>Data Table</h2>
    <table id="fpyTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Model</th>
          <th>PIC</th>
          <th>Target</th>
          <th>FPY %</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let rows = [];
    let chart;

    fetch("http://localhost:5000/data")
      .then(res => res.json())
      .then(data => {
        rows = data;
        renderTable(rows);
        renderKPI(rows);
        renderChart(rows);
      });

    function renderTable(data){
      const tbody = document.querySelector("#fpyTable tbody");
      tbody.innerHTML = "";
      data.forEach(r=>{
        const cls = r.FPY >= 98 ? "good" : r.FPY >= 95 ? "warn" : "bad";
        tbody.innerHTML += `
          <tr>
            <td>${r.Date ? r.Date.split("T")[0] : r.Day}</td>
            <td>${r.Model}</td>
            <td>${r.PIC}</td>
            <td>${r["Target Yield"]}%</td>
            <td class="${cls}">${r.FPY.toFixed(2)}%</td>
          </tr>`;
      });
    }

    function renderKPI(data){
      const fpy = (data.reduce((a,b)=>a+b.FPY,0)/data.length).toFixed(2);
      const models = [...new Set(data.map(d=>d.Model))].length;
      const days = [...new Set(data.map(d=>d.Day))].length;
      document.getElementById("kpiFPY").textContent = "Average FPY: " + fpy + "%";
      document.getElementById("kpiModels").textContent = "Models: " + models;
      document.getElementById("kpiDays").textContent = "Days Covered: " + days;
    }

    function renderChart(data){
      const ctx = document.getElementById("fpyChart").getContext("2d");
      if(chart) chart.destroy();

      // Group by Model
      const models = [...new Set(data.map(d=>d.Model))];
      const days = [...new Set(data.map(d=>d.Day))].sort((a,b)=>a-b);

      const datasets = models.map(model=>{
        const modelData = days.map(day=>{
          const rec = data.find(r=>r.Model===model && r.Day===day);
          return rec ? rec.FPY : null;
        });
        return {
          label:model,
          data:modelData,
          borderWidth:2,
          borderColor:randomColor(),
          fill:false
        }
      });

      chart = new Chart(ctx,{
        type:"line",
        data:{ labels:days, datasets },
        options:{
          responsive:true,
          interaction:{mode:'nearest',intersect:false},
          plugins:{legend:{position:"bottom"}},
          scales:{y:{min:0,max:100,ticks:{callback:v=>v+"%"}}}
        }
      });
    }

    function randomColor(){
      return `hsl(${Math.floor(Math.random()*360)},70%,60%)`;
    }
  </script>
</body>
</html>
